<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Paste to OCR</title>
  <style>
    body { font-family: system-ui, Arial; max-width: 900px; margin: 32px auto; }
    .container { display:flex; gap:16px; }
    .box { flex:1; }
    img { max-width:100%; border:1px solid #ddd; }
    textarea { width:100%; height:400px; }
    .controls { margin:10px 0; }
    .status { color: #666; font-size: 0.9rem; margin-top: 6px; }
  </style>
</head>
<body>
  <h1>Paste to OCR</h1>
  <p>Paste an image from your clipboard (Ctrl+V / Cmd+V) or choose a file. OCR runs automatically on paste/choose.</p>

  <div class="controls">
    <input type="file" id="fileInput" accept="image/*">
    <button id="ocrBtn">Upload & OCR (manual)</button>
    <span class="status" id="statusText"></span>
  </div>

  <div class="container">
    <div class="box">
      <h3>Image</h3>
      <div id="imageWrapper" style="min-height:200px; border:1px dashed #ccc; padding:10px;">Drop/paste an image here</div>
    </div>
    <div class="box">
      <h3>OCR Text</h3>
      <textarea id="result" placeholder="OCR text will appear here..."></textarea>
    </div>
  </div>

  <script>
    const fileInput = document.getElementById('fileInput');
    const imageWrapper = document.getElementById('imageWrapper');
    const ocrBtn = document.getElementById('ocrBtn');
    const resultArea = document.getElementById('result');
    const statusText = document.getElementById('statusText');

    let currentBlob = null;
    // prevent parallel uploads
    let uploading = false;

    function setStatus(msg) {
      statusText.textContent = msg || '';
    }

    function showImageFromBlob(blob, autoUpload = true) {
      currentBlob = blob;
      imageWrapper.innerHTML = '';
      const img = document.createElement('img');
      img.src = URL.createObjectURL(blob);
      img.onload = () => {
        // release object URL only after it's loaded to avoid blank image in some browsers
        URL.revokeObjectURL(img.src);
      };
      imageWrapper.appendChild(img);

      // Auto-upload after showing image
      if (autoUpload) {
        // small timeout so the image has a moment to render (not strictly required)
        setTimeout(uploadAndOCR, 50);
      }
    }

    // Handle file selection (auto upload)
    fileInput.addEventListener('change', (e) => {
      const f = e.target.files[0];
      if (!f) return;
      showImageFromBlob(f, true);
    });

    // Handle paste (clipboard)
    window.addEventListener('paste', (ev) => {
      const items = ev.clipboardData && ev.clipboardData.items;
      if (!items) return;
      for (let i = 0; i < items.length; i++) {
        const item = items[i];
        if (item.type && item.type.indexOf('image') === 0) {
          const blob = item.getAsFile();
          if (blob) {
            showImageFromBlob(blob, true);
            ev.preventDefault();
            break;
          }
        }
      }
    });

    async function uploadAndOCR() {
      if (!currentBlob) {
        alert('Paste or choose an image first.');
        return;
      }
      if (uploading) return; // skip if already in flight
      uploading = true;
      setStatus('Uploading and OCR-ing...');
      resultArea.value = ''; // clear previous result

      const fd = new FormData();
      fd.append('file', currentBlob, 'paste.png');

      try {
        // Use relative path so it works when served from the same origin (recommended)
        const resp = await fetch('/ocr', {
          method: 'POST',
          body: fd
        });
        if (!resp.ok) {
          throw new Error('Network error: ' + resp.status + ' ' + resp.statusText);
        }
        const data = await resp.json();
        resultArea.value = data.text || '';
        setStatus('Done');
      } catch (err) {
        resultArea.value = 'Error: ' + err.message;
        setStatus('Error');
      } finally {
        uploading = false;
      }
    }

    // Manual button remains available if you want to retry
    ocrBtn.addEventListener('click', uploadAndOCR);

    // Optional: allow Enter in textarea to copy result to clipboard quickly
    resultArea.addEventListener('keydown', async (e) => {
      if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
        try {
          await navigator.clipboard.writeText(resultArea.value);
          setStatus('Copied to clipboard');
        } catch {
          setStatus('Copy failed');
        }
      }
    });
  </script>
</body>
</html>